@page "/strategies"
@inject IStrategyService StrategyService
@inject IClusterStrategyService ClusterStrategyService

<PageTitle>Strategies - KubeFleet UI</PageTitle>

<h1>Staged Update Strategies</h1>

@if (_loading)
{
    <FluentProgress />
}
else if (_error != null)
{
    <FluentMessageBar Title="Error" Intent="MessageIntent.Error">@_error</FluentMessageBar>
}
else
{
    <FluentDataGrid Items="@_strategies" ResizableColumns="true">
        <PropertyColumn Property="@(s => s.Metadata.Name)" Title="Name" Sortable="true" />
        <PropertyColumn Property="@(s => s.Metadata.Namespace)" Title="Namespace" Sortable="true" />
        <TemplateColumn Title="Stages">
            @context.Spec.Stages.Count
        </TemplateColumn>
        <TemplateColumn Title="Stage Names">
            @string.Join(", ", context.Spec.Stages.Select(s => s.Name))
        </TemplateColumn>
        <TemplateColumn Title="Age">
            @FormatAge(context.Metadata.CreationTimestamp)
        </TemplateColumn>
    </FluentDataGrid>
}

<h1>Cluster Staged Update Strategies</h1>

@if (_clusterLoading)
{
    <FluentProgress />
}
else if (_clusterError != null)
{
    <FluentMessageBar Title="Error" Intent="MessageIntent.Error">@_clusterError</FluentMessageBar>
}
else
{
    <FluentDataGrid Items="@_clusterStrategies" ResizableColumns="true">
        <PropertyColumn Property="@(s => s.Metadata.Name)" Title="Name" Sortable="true" />
        <TemplateColumn Title="Stages">
            @context.Spec.Stages.Count
        </TemplateColumn>
        <TemplateColumn Title="Stage Names">
            @string.Join(", ", context.Spec.Stages.Select(s => s.Name))
        </TemplateColumn>
        <TemplateColumn Title="Age">
            @FormatAge(context.Metadata.CreationTimestamp)
        </TemplateColumn>
    </FluentDataGrid>
}

@code {
    private IQueryable<StagedUpdateStrategy>? _strategies;
    private IQueryable<ClusterStagedUpdateStrategy>? _clusterStrategies;
    private bool _loading = true;
    private bool _clusterLoading = true;
    private string? _error;
    private string? _clusterError;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var list = await StrategyService.ListAsync();
            _strategies = list.AsQueryable();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }

        try
        {
            var clusterList = await ClusterStrategyService.ListAsync();
            _clusterStrategies = clusterList.AsQueryable();
        }
        catch (Exception ex)
        {
            _clusterError = ex.Message;
        }
        finally
        {
            _clusterLoading = false;
        }
    }

    private string FormatAge(DateTime? created)
    {
        if (created == null) return "â€”";
        var age = DateTime.UtcNow - created.Value;
        if (age.TotalDays >= 1) return $"{(int)age.TotalDays}d";
        if (age.TotalHours >= 1) return $"{(int)age.TotalHours}h";
        return $"{(int)age.TotalMinutes}m";
    }
}
