@page "/create"
@inject IUpdateRunService UpdateRunService
@inject IClusterUpdateRunService ClusterUpdateRunService
@inject IStrategyService StrategyService
@inject IClusterStrategyService ClusterStrategyService
@inject IPlacementService PlacementService
@inject IClusterPlacementService ClusterPlacementService
@inject NavigationManager Navigation

<PageTitle>Create Update Run - KubeFleet UI</PageTitle>

<h1>Create Staged Update Run</h1>

@if (_error != null)
{
    <FluentMessageBar Title="Error" Intent="MessageIntent.Error">@_error</FluentMessageBar>
}

<EditForm Model="@_model" OnValidSubmit="@HandleSubmit" FormName="create-run">
    <DataAnnotationsValidator />
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
        <div>
            <FluentSelect @bind-Value="_model.ResourceType" Label="Resource Type" TOption="string" Items="@_resourceTypes" Style="width: 100%;" @bind-Value:after="OnResourceTypeChanged" />
        </div>
        <div>
            <FluentTextField @bind-Value="_model.Name" Label="Name" Required="true" Style="width: 100%;" />
        </div>
        @if (!IsClusterScoped)
        {
            <div>
                <FluentTextField @bind-Value="_model.Namespace" Label="Namespace" Style="width: 100%;" />
            </div>
        }
        <div>
            <FluentSelect @bind-Value="_model.PlacementName" Label="Placement" TOption="string" Items="@_placementNames" Style="width: 100%;" />
        </div>
        <div>
            <FluentSelect @bind-Value="_model.StrategyName" Label="Strategy" TOption="string" Items="@_strategyNames" Style="width: 100%;" />
        </div>
        <div>
            <FluentTextField @bind-Value="_model.ResourceSnapshotIndex" Label="Resource Snapshot Index (optional)" Style="width: 100%;" />
        </div>
        <div>
            <FluentSelect @bind-Value="_model.InitialState" Label="Initial State" TOption="string" Items="@_states" Style="width: 100%;" />
        </div>
        <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Loading="@_submitting">
            Create
        </FluentButton>
    </FluentStack>
</EditForm>

@code {
    private CreateRunModel _model = new();
    private List<string> _strategyNames = new();
    private List<string> _placementNames = new();
    private List<string> _resourceTypes = new() { "StagedUpdateRun", "ClusterStagedUpdateRun" };
    private List<string> _states = new() { "Initialize", "Run" };
    private bool _submitting;
    private string? _error;

    private bool IsClusterScoped => _model.ResourceType == "ClusterStagedUpdateRun";

    protected override async Task OnInitializedAsync()
    {
        await LoadScopedData();
    }

    private async Task OnResourceTypeChanged()
    {
        _model.StrategyName = string.Empty;
        _model.PlacementName = string.Empty;
        await LoadScopedData();
    }

    private async Task LoadScopedData()
    {
        _strategyNames = new List<string>();
        _placementNames = new List<string>();

        if (IsClusterScoped)
        {
            try
            {
                var clusterStrategies = await ClusterStrategyService.ListAsync();
                _strategyNames = clusterStrategies.Select(s => s.Metadata.Name).ToList();
            }
            catch
            {
                // Cluster strategy list may fail if not connected
            }

            try
            {
                var clusterPlacements = await ClusterPlacementService.ListAsync();
                _placementNames = clusterPlacements.Select(p => p.Metadata.Name).ToList();
            }
            catch
            {
                // Cluster placement list may fail if not connected
            }
        }
        else
        {
            try
            {
                var strategies = await StrategyService.ListAsync();
                _strategyNames = strategies.Select(s => s.Metadata.Name).ToList();
            }
            catch
            {
                // Strategy list may fail if not connected
            }

            try
            {
                var placements = await PlacementService.ListAsync();
                _placementNames = placements.Select(p => p.Metadata.Name).ToList();
            }
            catch
            {
                // Placement list may fail if not connected
            }
        }
    }

    private async Task HandleSubmit()
    {
        _submitting = true;
        _error = null;
        try
        {
            if (IsClusterScoped)
            {
                var run = new ClusterStagedUpdateRun
                {
                    Metadata = new ResourceMetadata
                    {
                        Name = _model.Name
                    },
                    Spec = new UpdateRunSpec
                    {
                        PlacementName = _model.PlacementName,
                        StagedUpdateStrategyName = _model.StrategyName,
                        ResourceSnapshotIndex = string.IsNullOrWhiteSpace(_model.ResourceSnapshotIndex) ? null : _model.ResourceSnapshotIndex,
                        State = Enum.Parse<UpdateRunState>(_model.InitialState)
                    }
                };

                var created = await ClusterUpdateRunService.CreateAsync(run);
                Navigation.NavigateTo($"/run/{created.Metadata.Name}");
            }
            else
            {
                var run = new StagedUpdateRun
                {
                    Metadata = new ResourceMetadata
                    {
                        Name = _model.Name,
                        Namespace = string.IsNullOrWhiteSpace(_model.Namespace) ? null : _model.Namespace
                    },
                    Spec = new UpdateRunSpec
                    {
                        PlacementName = _model.PlacementName,
                        StagedUpdateStrategyName = _model.StrategyName,
                        ResourceSnapshotIndex = string.IsNullOrWhiteSpace(_model.ResourceSnapshotIndex) ? null : _model.ResourceSnapshotIndex,
                        State = Enum.Parse<UpdateRunState>(_model.InitialState)
                    }
                };

                var created = await UpdateRunService.CreateAsync(run);
                Navigation.NavigateTo($"/run/{created.Metadata.Namespace}/{created.Metadata.Name}");
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _submitting = false;
        }
    }

    private class CreateRunModel
    {
        public string ResourceType { get; set; } = "StagedUpdateRun";
        public string Name { get; set; } = string.Empty;
        public string Namespace { get; set; } = string.Empty;
        public string PlacementName { get; set; } = string.Empty;
        public string StrategyName { get; set; } = string.Empty;
        public string ResourceSnapshotIndex { get; set; } = string.Empty;
        public string InitialState { get; set; } = "Initialize";
    }
}
