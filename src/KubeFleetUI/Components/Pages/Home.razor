@page "/"
@inject IUpdateRunService UpdateRunService
@inject IClusterUpdateRunService ClusterUpdateRunService
@inject NavigationManager Navigation

<PageTitle>Dashboard - KubeFleet UI</PageTitle>

<h1>Staged Update Runs</h1>

<FluentToolbar>
    <FluentButton Appearance="Appearance.Accent" OnClick="@(() => Navigation.NavigateTo("/create"))">
        Create New Run
    </FluentButton>
    <FluentButton Appearance="Appearance.Outline" OnClick="@LoadRuns">
        Refresh
    </FluentButton>
</FluentToolbar>

@if (_loading)
{
    <FluentProgress />
}
else if (_error != null)
{
    <FluentMessageBar Title="Error" Intent="MessageIntent.Error">
        @_error
    </FluentMessageBar>
}
else
{
    <FluentDataGrid Items="@_allRuns" ResizableColumns="true" Style="margin-top: 1rem;">
        <PropertyColumn Property="@(r => r.Name)" Title="Name" Sortable="true" />
        <TemplateColumn Title="Kind" Sortable="true">
            <FluentBadge Appearance="@(context.IsClusterScoped ? Appearance.Accent : Appearance.Neutral)">@context.Kind</FluentBadge>
        </TemplateColumn>
        <PropertyColumn Property="@(r => r.Namespace)" Title="Namespace" Sortable="true" />
        <PropertyColumn Property="@(r => r.PlacementName)" Title="Placement" Sortable="true" />
        <PropertyColumn Property="@(r => r.StrategyName)" Title="Strategy" Sortable="true" />
        <TemplateColumn Title="State">
            <FluentBadge Appearance="Appearance.Accent">@context.State</FluentBadge>
        </TemplateColumn>
        <TemplateColumn Title="Initialized">
            @{
                var init = GetConditionStatus(context, "Initialized");
            }
            <FluentBadge BackgroundColor="@GetStatusColor(init)">@init</FluentBadge>
        </TemplateColumn>
        <TemplateColumn Title="Progressing">
            @{
                var prog = GetConditionStatus(context, "Progressing");
            }
            <FluentBadge BackgroundColor="@GetStatusColor(prog)">@prog</FluentBadge>
        </TemplateColumn>
        <TemplateColumn Title="Succeeded">
            @{
                var succ = GetConditionStatus(context, "Succeeded");
            }
            <FluentBadge BackgroundColor="@GetStatusColor(succ)">@succ</FluentBadge>
        </TemplateColumn>
        <TemplateColumn Title="Age">
            @FormatAge(context.CreationTimestamp)
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => NavigateToDetail(context))">
                View
            </FluentButton>
        </TemplateColumn>
    </FluentDataGrid>
}

@code {
    private IQueryable<UpdateRunViewModel>? _allRuns;
    private bool _loading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        await LoadRuns();
    }

    private async Task LoadRuns()
    {
        _loading = true;
        _error = null;
        try
        {
            var viewModels = new List<UpdateRunViewModel>();

            var namespacedRuns = await UpdateRunService.ListAsync();
            viewModels.AddRange(namespacedRuns.Select(r => new UpdateRunViewModel(r)));

            var clusterRuns = await ClusterUpdateRunService.ListAsync();
            viewModels.AddRange(clusterRuns.Select(r => new UpdateRunViewModel(r)));

            _allRuns = viewModels.AsQueryable();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToDetail(UpdateRunViewModel run)
    {
        if (run.IsClusterScoped)
        {
            Navigation.NavigateTo($"/clusterrun/{run.Name}");
        }
        else
        {
            Navigation.NavigateTo($"/run/{run.Namespace}/{run.Name}");
        }
    }

    private string GetConditionStatus(UpdateRunViewModel run, string conditionType)
    {
        var condition = run.Conditions?.FirstOrDefault(c => c.Type == conditionType);
        return condition?.Status ?? "—";
    }

    private string GetStatusColor(string status) => status switch
    {
        "True" => "#0E700E",
        "False" => "#C50F1F",
        _ => "#616161"
    };

    private string FormatAge(DateTime? created)
    {
        if (created == null) return "—";
        var age = DateTime.UtcNow - created.Value;
        if (age.TotalDays >= 1) return $"{(int)age.TotalDays}d";
        if (age.TotalHours >= 1) return $"{(int)age.TotalHours}h";
        return $"{(int)age.TotalMinutes}m";
    }

    public class UpdateRunViewModel
    {
        public string Name { get; }
        public string? Namespace { get; }
        public string Kind { get; }
        public bool IsClusterScoped { get; }
        public string PlacementName { get; }
        public string StrategyName { get; }
        public UpdateRunState State { get; }
        public DateTime? CreationTimestamp { get; }
        public List<Condition>? Conditions { get; }

        public UpdateRunViewModel(StagedUpdateRun run)
        {
            Name = run.Metadata.Name;
            Namespace = run.Metadata.Namespace;
            Kind = run.Kind;
            IsClusterScoped = false;
            PlacementName = run.Spec.PlacementName;
            StrategyName = run.Spec.StagedUpdateStrategyName;
            State = run.Spec.State;
            CreationTimestamp = run.Metadata.CreationTimestamp;
            Conditions = run.Status?.Conditions;
        }

        public UpdateRunViewModel(ClusterStagedUpdateRun run)
        {
            Name = run.Metadata.Name;
            Namespace = null;
            Kind = run.Kind;
            IsClusterScoped = true;
            PlacementName = run.Spec.PlacementName;
            StrategyName = run.Spec.StagedUpdateStrategyName;
            State = run.Spec.State;
            CreationTimestamp = run.Metadata.CreationTimestamp;
            Conditions = run.Status?.Conditions;
        }
    }
}
