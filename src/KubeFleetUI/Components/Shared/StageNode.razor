<div class="stage-node @GetStageClass()">
    <div class="stage-header">
        <strong>@(IsDeletionStage ? "Deletion Stage" : Stage.StageName)</strong>
        @if (Stage.StartTime.HasValue)
        {
            <span class="stage-time">@Stage.StartTime.Value.ToString("HH:mm:ss")</span>
        }
    </div>
    <div class="stage-clusters">
        @foreach (var cluster in Stage.Clusters)
        {
            <ClusterChip Cluster="@cluster" />
        }
    </div>
    @if (Stage.Conditions != null)
    {
        <div class="stage-conditions">
            @foreach (var c in Stage.Conditions)
            {
                <span class="condition @GetConditionClass(c)">@c.Type: @c.Status</span>
            }
        </div>
    }
</div>

@code {
    [Parameter] public StageUpdatingStatus Stage { get; set; } = new();
    [Parameter] public bool IsDeletionStage { get; set; }

    private string GetStageClass()
    {
        // Check stage-level conditions first
        var succeeded = Stage.Conditions?.FirstOrDefault(c => c.Type == "Succeeded");
        if (succeeded?.Status == "True") return "stage-succeeded";

        // Check cluster statuses to determine stage state
        if (Stage.Clusters.Any())
        {
            // Flatten all cluster conditions for easier checking
            var allClusterConditions = Stage.Clusters
                .Where(c => c.Conditions != null && c.Conditions.Any())
                .SelectMany(c => c.Conditions!)
                .ToList();

            if (!allClusterConditions.Any())
            {
                // No conditions available yet, stage is pending
                return Stage.StartTime.HasValue ? "stage-active" : "stage-pending";
            }

            // Check if any cluster has failed
            var anyFailed = allClusterConditions
                .Any(cond => cond.Type == "Succeeded" && cond.Status == "False");
            if (anyFailed) return "stage-failed";

            // Check if all clusters have succeeded
            var clustersWithConditions = Stage.Clusters
                .Count(c => c.Conditions != null && c.Conditions.Any());
            var succeededCount = Stage.Clusters
                .Count(c => c.Conditions?.Any(cond => cond.Type == "Succeeded" && cond.Status == "True") == true);
            if (clustersWithConditions > 0 && succeededCount == clustersWithConditions)
            {
                return "stage-succeeded";
            }

            // Check if any cluster has started
            var anyStarted = allClusterConditions
                .Any(cond => cond.Type == "Started" && cond.Status == "True");
            if (anyStarted) return "stage-active";
        }

        // Fall back to stage conditions
        var progressing = Stage.Conditions?.FirstOrDefault(c => c.Type == "Progressing");
        if (progressing?.Status == "True") return "stage-active";
        if (progressing?.Status == "False") return "stage-waiting";

        return Stage.StartTime.HasValue ? "stage-active" : "stage-pending";
    }

    private string GetConditionClass(Condition c) => c.Status switch
    {
        "True" => "condition-true",
        "False" => "condition-false",
        _ => "condition-unknown"
    };
}
